<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>STANDALONE OS | User Interface</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* 保留您最愛的 Cyberpunk 視覺風格 */
  :root {
    --accent: #fff; --glow: rgba(255, 255, 255, 0.5); --bg-deep: #000;
    --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08);
    --aurora-1: #00f260; --aurora-2: #0575e6; --aurora-3: #00f260;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; padding: 0; font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-deep); color: #fff; height: 100dvh; width: 100vw; display: flex; flex-direction: column; overflow: hidden; }
  
  .aether-void { position: absolute; inset: -50%; background: conic-gradient(from 0deg, transparent 0deg, var(--aurora-1) 60deg, transparent 120deg, var(--aurora-2) 180deg, transparent 240deg, var(--aurora-3) 300deg, transparent 360deg); filter: blur(90px); opacity: 0.35; animation: rotateVoid 30s linear infinite; z-index: -1; transition: all 2s ease; }
  .noise-overlay { position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: -1; }
  @keyframes rotateVoid { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .hud-top { flex: 0 0 auto; padding: calc(20px + env(safe-area-inset-top)) 24px 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); backdrop-filter: blur(10px); z-index: 10; }
  .brand-logo { font-size: 16px; letter-spacing: 1px; font-weight: 700; color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 10px; }
  .status-light { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 2s infinite; }
  
  .nav-actions { display: flex; gap: 8px; }
  .nav-btn { background: var(--glass); border: 1px solid var(--border); color: rgba(255,255,255,0.9); text-decoration: none; font-size: 14px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.3s; }
  .nav-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--glow); transform: scale(1.1); }

  .stream-viewport { flex: 1; overflow-y: auto; padding: 30px 24px; display: flex; flex-direction: column; gap: 24px; mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%); scroll-behavior: smooth; }
  .node { display: flex; flex-direction: column; max-width: 88%; animation: driftUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
  .node.bot { align-self: flex-start; border-left: 2px solid var(--accent); padding-left: 18px; }
  .node.user { align-self: flex-end; align-items: flex-end; border-right: 2px solid rgba(255,255,255,0.3); padding-right: 18px; }
  .node-text { font-size: 15px; line-height: 1.7; font-weight: 400; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
  .node.bot .node-text { color: rgba(255,255,255,0.95); }
  .node.user .node-text { color: var(--accent); text-align: right; }

  .monolith-dock { flex: 0 0 auto; padding: 0 0 calc(20px + env(safe-area-inset-bottom)) 0; background: linear-gradient(to top, #000 40%, transparent); display: flex; flex-direction: column; gap: 15px; z-index: 20; }
  .orbit-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
  .orbit-bar { display: flex; gap: 10px; overflow-x: auto; padding: 5px 24px; scrollbar-width: none; flex: 1; scroll-behavior: smooth; }

  /* 捲動箭頭樣式 */
  .scroll-btn-right {
    position: absolute; right: 0; top: 0; bottom: 0; width: 40px;
    background: linear-gradient(to left, #000 40%, transparent);
    display: flex; align-items: center; justify-content: center;
    z-index: 5; cursor: pointer; color: var(--accent);
    animation: bounceRight 2s infinite;
    display: none; /* 預設隱藏，由 JS 控制 */
  }
  @keyframes bounceRight { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }

  .core-input-wrapper { margin: 0 24px; height: 50px; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 15px; transition: 0.3s; }
  .core-input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
  .transmit-btn { background: transparent; border: none; color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; }

  @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
  @keyframes driftUp { from { opacity: 0; transform: translateY(20px); filter: blur(5px); } to { opacity: 1; transform: translateY(0); filter: blur(0); } }

  .boot-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Space Grotesk', monospace; transition: opacity 1s ease; }
  .glitch-text { font-size: 26px; letter-spacing: 3px; color: #fff; animation: glitch 1s infinite; }
  @keyframes glitch { 0% { opacity: 1; } 50% { opacity: 0.8; text-shadow: 2px 0 red, -2px 0 blue; } 100% { opacity: 1; } }

  #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000000; z-index: 2147483647 !important; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .login-box { width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-radius: 20px; padding: 40px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); }
  .login-title { color: #fff; font-size: 20px; margin-bottom: 20px; letter-spacing: 2px; }
  .login-input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #00ff88; font-family: monospace; text-align: center; font-size: 16px; border-radius: 10px; margin-bottom: 20px; outline: none; }
  .login-btn { padding: 12px 30px; background: #00ff88; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <div class="login-title">SYSTEM LOGIN</div>
        <p style="color:#888; font-size:12px; margin-bottom:20px;">請輸入您的系統 ID (Access Token)</p>
        <input type="text" id="unique_gate_input" class="login-input" placeholder="Paste ID Here...">
        <button class="login-btn" onclick="executeFinalLogin()">ENTER SYSTEM</button>
    </div>
</div>

<script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentId = urlParams.get('id');
        const overlay = document.getElementById('loginOverlay');
        if (currentId) {
            if (overlay) overlay.remove();
        } else {
            if (overlay) {
                overlay.style.display = 'flex'; 
                const myInput = document.getElementById('unique_gate_input');
                if (myInput) {
                    myInput.addEventListener("keypress", function(event) {
                        if (event.key === "Enter") { event.preventDefault(); executeFinalLogin(); }
                    });
                    setTimeout(() => myInput.focus(), 100); 
                }
            }
            const style = document.createElement('style');
            style.innerHTML = `body > *:not(#loginOverlay):not(script) { display: none !important; }`;
            document.head.appendChild(style);
        }
    })();

    function executeFinalLogin() {
        const inputEl = document.getElementById('unique_gate_input');
        if (!inputEl) return;
        const finalVal = inputEl.value.trim();
        if (finalVal && finalVal.length > 5) window.location.href = window.location.pathname + '?id=' + finalVal;
        else alert("錯誤：ID 無效！");
    }
</script>

<div class="aether-void" id="aetherBg"></div>
<div class="noise-overlay"></div>

<div class="boot-screen" id="bootLayer">
  <div class="glitch-text">STANDALONE_OS</div>
  <div style="margin-top:20px; font-size:12px; color:#666; letter-spacing:1px;" id="bootStatus">核心連線中...</div>
</div>

<div class="hud-top">
  <div class="brand-logo">
    <div class="status-light" id="statusLight"></div>
    <span id="brandTitle">SYSTEM STANDBY</span>
  </div>
  <div class="nav-actions" id="socialDeck"></div>
</div>

<div class="stream-viewport" id="chatBody"></div>

====這是要替換的內容 (加入箭頭 + 改中文)：====
<div class="monolith-dock">
  <div class="orbit-wrapper">
    <div class="orbit-bar" id="quickActions"></div>
    <!-- 補回箭頭按鈕 -->
    <div class="scroll-btn-right" id="scrollArrow" onclick="scrollMenu()">
        <i class="fas fa-chevron-right"></i>
    </div>
  </div>
  <div class="core-input-wrapper">
    <input type="text" class="core-input" id="userInput" placeholder="輸入訊息..." autocomplete="off">
    <!-- 改為中文 -->
    <button class="transmit-btn" onclick="handleSend()">送出</button>
  </div>
</div>

<script>
// ========================================================
// 1. Supabase 連線設定 (請務必填寫)
// ========================================================
const supabaseUrl = 'https://skkjzquxollefddyhtxt.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNra2p6cXV4b2xsZWZkZHlodHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTQ4NzMsImV4cCI6MjA4MDA3MDg3M30.S0tcaKijsb-rrJuZWeBn9uUr8geu63qKNa-cdgjS12I';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const urlParams = new URLSearchParams(window.location.search);
const CLIENT_ID = urlParams.get('id');
let currentQnA = [];

async function init() {
  if (!CLIENT_ID) return;

  try {
    document.getElementById('bootStatus').innerText = "DOWNLOADING PROFILE...";
    
    // 讀取設定
    const { data: profile, error: err1 } = await supabaseClient.from('profiles').select('*').eq('id', CLIENT_ID).single();
    if (err1 || !profile) throw new Error("ACCESS DENIED");

    // 讀取問答
    const { data: rules, error: err2 } = await supabaseClient.from('qna_rules').select('*').eq('user_id', CLIENT_ID).order('created_at', {ascending: true});
    currentQnA = rules || [];

    applyTheme(profile);
    renderSocials(profile);
    updateOrbit(currentQnA);

    setTimeout(() => {
        document.getElementById("bootLayer").style.opacity = 0;
        setTimeout(()=> document.getElementById("bootLayer").style.display = "none", 1000);
        setTimeout(() => { addNode("bot", profile.welcome_msg || "SYSTEM READY."); }, 500);
    }, 1500);

  } catch (e) {
    console.error(e);
    document.querySelector('.glitch-text').innerText = "CONNECTION_LOST";
    document.querySelector('.glitch-text').style.color = "#ff3b30";
  }
}

function applyTheme(profile) {
  document.getElementById('brandTitle').innerText = profile.brand_name || "STANDALONE";
  document.title = profile.brand_name || "STANDALONE OS";
  const root = document.documentElement;
  const color = profile.theme_color || '#00f260';
  root.style.setProperty('--accent', color);
  root.style.setProperty('--glow', color);
  root.style.setProperty('--aurora-1', color);
  document.getElementById("statusLight").style.backgroundColor = color;
  document.getElementById("statusLight").style.boxShadow = `0 0 10px ${color}`;
}


function renderSocials(profile) {
    const deck = document.getElementById('socialDeck'); deck.innerHTML = '';
    const links = [
        { icon: 'fas fa-phone', val: profile.link_phone, type: 'tel' },
        { icon: 'fas fa-envelope', val: profile.link_mail, type: 'mailto' },
        { icon: 'fab fa-line', val: profile.link_line, type: 'line' }, // 標記為 line 類型
        { icon: 'fab fa-instagram', val: profile.link_ig },
        { icon: 'fab fa-facebook-f', val: profile.link_fb },
        { icon: 'fas fa-at', val: profile.link_threads }
    ];
    links.forEach(link => {
        if (link.val) {
            const a = document.createElement('a'); a.className = 'nav-btn';
            let href = link.val;
            
            // 智能連結處理
            if (link.type === 'tel') {
                href = `tel:${link.val}`;
            } else if (link.type === 'mailto') {
                href = `mailto:${link.val}`;
            } else if (link.type === 'line') {
                // LINE 特殊處理：如果是連結直接用，如果是 ID 則加上前綴
                if (href.startsWith('http')) {
                     // 保持原樣
                } else if (href.startsWith('@')) {
                     href = `https://line.me/R/ti/p/${href}`; // 官方帳號
                } else {
                     href = `https://line.me/ti/p/~${href}`; // 個人 ID
                }
            } else {
                // 其他社群連結 (IG/FB/Threads)
                if (!href.startsWith('http')) href = `https://${href}`;
            }

            a.href = href; a.target = '_blank';
            a.innerHTML = `<i class="${link.icon}"></i>`;
            deck.appendChild(a);
        }
    });
}



function updateOrbit(faqs) {
  const bar = document.getElementById("quickActions"); bar.innerHTML = "";
  const arrow = document.getElementById("scrollArrow");
  
  if(faqs && faqs.length > 0) {
    faqs.forEach(item => {
      const chip = document.createElement("button"); chip.className = "orbit-chip";
      chip.innerText = item.question;
      chip.onclick = () => handleInput(item.question, item.answer, item.id);
      bar.appendChild(chip);
    });
    // 檢查是否需要顯示箭頭 (延遲一下等待渲染)
    setTimeout(() => {
        if (bar.scrollWidth > bar.clientWidth) {
            arrow.style.display = "flex";
        } else {
            arrow.style.display = "none";
        }
    }, 100);
  } else {
     if(arrow) arrow.style.display = "none";
  }
}

// 新增：捲動功能
function scrollMenu() {
    const bar = document.getElementById("quickActions");
    bar.scrollBy({ left: 150, behavior: 'smooth' });
}
// 新增：監聽捲動以隱藏箭頭
document.getElementById("quickActions").addEventListener("scroll", function() {
   const bar = this;
   const arrow = document.getElementById("scrollArrow");
   if(bar.scrollLeft + bar.clientWidth >= bar.scrollWidth - 10) {
       arrow.style.opacity = "0"; 
   } else {
       arrow.style.opacity = "1";
   }
});


// ========================================================
// 新增：寫入 Log 的功能
// ========================================================
async function logToCloud(msg, response, type) {
    if (!CLIENT_ID) return;
    // 這裡我們不等待結果 (Fire and Forget)，以免卡住介面
    supabaseClient.from('chat_logs').insert([
        { user_id: CLIENT_ID, message: msg, bot_response: response, type: type }
    ]).then(({ error }) => {
        if(error) console.error("Log Error:", error);
    });
}

// 修改後的按鈕點擊處理
function handleInput(q, a, id) {
  addNode("user", q);
  showProcessing();
  
  // 1. 計數 (既有功能)
  if (id && CLIENT_ID) {
      supabaseClient.rpc('increment_click_count', { row_id: id });
  }
  // 2. 寫入 Log (新功能)
  logToCloud(q, a, 'button');

  setTimeout(() => { removeProcessing(); addNode("bot", a); }, 800);
}

// 修改後的文字發送處理
function handleSend() {
  const input = document.getElementById("userInput"); const text = input.value.trim();
  if(!text) return;
  addNode("user", text); input.value = ""; showProcessing();
  
  let ans = "如需詳細服務，請點擊上方按鈕聯絡專人。";
  if (currentQnA.length > 0) {
    for(let f of currentQnA) {
        if(text.includes(f.question)) { ans = f.answer; break; }
    }
  }
  
  // 寫入 Log (新功能)
  logToCloud(text, ans, 'text');

  setTimeout(() => { removeProcessing(); addNode("bot", ans); }, 1000);
}

function addNode(role, text) {
  const body = document.getElementById("chatBody");
  const node = document.createElement("div"); node.className = `node ${role}`;
  node.innerHTML = `<div class="node-text">${text.replace(/\n/g, '<br>')}</div>`;
  body.appendChild(node); body.scrollTop = body.scrollHeight;
}

function showProcessing() {
  const body = document.getElementById("chatBody");
  const node = document.createElement("div"); node.id = "procNode"; node.className = "node bot";
  node.innerHTML = `<div class="node-text" style="opacity:0.6; font-size:12px; letter-spacing:1px;">COMPUTING...</div>`;
  body.appendChild(node); body.scrollTop = body.scrollHeight;
}

function removeProcessing() { const el = document.getElementById("procNode"); if(el) el.remove(); }
document.getElementById("userInput").addEventListener("keypress", (e) => { if(e.key==="Enter") handleSend(); });

init();
</script>
</body>
</html>