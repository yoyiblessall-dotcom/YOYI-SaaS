<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
user-scalable=no, viewport-fit=cover,
interactive-widget=resizes-content">
<title>YOYI | Digital
Twin</title>
<link
href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@500;700&display=swap"
rel="stylesheet">
<link
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
rel="stylesheet">
<script
src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
 :root { --accent: #00f260; --glow: rgba(0, 242, 96, 0.4); --bg-deep:
#000; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.15);
--aurora-1: #00f260; --aurora-2: #0575e6; --aurora-3: #00f260; }
  * {
box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
 body { margin: 0; padding: 0; font-family: 'Space Grotesk',
-apple-system, "Microsoft JhengHei", sans-serif; background-color:
var(--bg-deep); color: #fff; height: 100dvh; width: 100vw; display: flex;
flex-direction: column; overflow: hidden; }
 .aether-void { position: absolute; inset: -50%; background:
conic-gradient(from 0deg, transparent 0deg, var(--aurora-1) 60deg, transparent
120deg, var(--aurora-2) 180deg, transparent 240deg, var(--aurora-3) 300deg,
transparent 360deg); filter: blur(90px); opacity: 0.35; animation: rotateVoid
30s linear infinite; z-index: -1; transition: all 2s ease; }
 .noise-overlay { position: absolute; inset: 0; background:
url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200'
xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence
type='fractalNoise' baseFrequency='0.7' numOctaves='3'
stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25'
filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events:
none; z-index: -1; }
 @keyframes rotateVoid { from { transform: rotate(0deg); } to {
transform: rotate(360deg); } }
 @keyframes pulse { 0%, 100% { box-shadow: 0 0 10px var(--accent); } 50%
{ box-shadow: 0 0 25px var(--accent); } }
 .hud-top { flex: 0 0 auto; padding: calc(20px +
env(safe-area-inset-top)) 24px 20px 24px; display: flex; justify-content:
space-between; align-items: center; border-bottom: 1px solid
rgba(255,255,255,0.05); background: linear-gradient(to bottom, rgba(0,0,0,0.8),
transparent); backdrop-filter: blur(10px); z-index: 10; }
 .brand-logo { font-size: 16px; letter-spacing: 1px; font-weight: 700;
color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 10px; }
 .status-light { width: 6px; height: 6px; background: var(--accent);
border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 2s
infinite; }
 .nav-actions { display: flex; gap: 12px; }
 .nav-btn { background: rgba(255,255,255,0.1); border: 1px solid
var(--border); color: rgba(255,255,255,0.9); text-decoration: none; font-size:
14px; width: 36px; height: 36px; display: flex; align-items: center;
justify-content: center; border-radius: 50%; transition: 0.3s; }
 .nav-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0
15px var(--glow); transform: scale(1.1); }
 .stream-viewport { flex: 1; overflow-y: auto; padding: 30px 24px;
display: flex; flex-direction: column; gap: 24px; mask-image:
linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent
100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black
10%, black 90%, transparent 100%); }
 .stream-viewport::-webkit-scrollbar { width: 0; }
 .bot-msg { background: var(--glass); border: 1px solid var(--border);
border-radius: 12px; padding: 20px; max-width: 85%; align-self: flex-start;
position: relative; backdrop-filter: blur(10px); animation: fadeIn 0.4s ease-out;
}
 .user-msg { background: var(--accent); color: #000; border-radius: 12px;
padding: 15px; max-width: 85%; align-self: flex-end; font-weight: 600;
animation: fadeInRight 0.4s ease-out; }
 .bot-text { font-size: 14px; line-height: 1.6; color:
rgba(255,255,255,0.9); }
 .welcome-msg { font-size: 18px; font-weight: 700; letter-spacing: 1px;
margin-bottom: 5px; color: var(--accent); text-shadow: 0 0 10px
rgba(0,0,0,0.5); }
 .qa-prompt { font-size: 12px; color: rgba(255,255,255,0.4); margin-top:
15px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
 .qa-deck { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
}
 .qa-btn { background: rgba(255,255,255,0.1); border: 1px solid
var(--border); color: #fff; padding: 10px 18px; border-radius: 20px;
font-size: 13px; cursor: pointer; transition: 0.3s; white-space: nowrap;
max-width: 100%; overflow: hidden; text-overflow: ellipsis; font-family:
inherit; }
 .qa-btn:hover { background: var(--accent); color: #000; border-color:
var(--accent); box-shadow: 0 0 10px var(--glow); }
 .input-hud { flex: 0 0 auto; padding: 15px 24px
calc(15px + env(safe-area-inset-bottom)) 24px; border-top: 1px solid
rgba(255,255,255,0.05); background: #000; z-index: 10; display: flex; gap:
10px; }
 .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px
solid var(--border); border-radius: 25px; color: #fff; padding: 10px 15px;
font-size: 14px; font-family: inherit; transition: 0.3s; }
 .chat-input:focus { border-color: var(--accent); background:
rgba(255,255,255,0.1); }
 .send-btn { width: 40px; height: 40px; background: var(--accent); color:
#000; border: none; border-radius: 50%; display: flex; align-items: center;
justify-content: center; cursor: pointer; transition: 0.3s; }
 .send-btn:hover { opacity: 0.8; box-shadow: 0 0 10px var(--glow); }
 .contact-bar { margin-top: 20px; padding-top: 15px; border-top: 1px
solid var(--border); display: flex; justify-content: center; gap: 20px; }
 .contact-link { color: rgba(255,255,255,0.7); font-size: 18px;
transition: 0.3s; }
 .contact-link:hover { color: var(--accent); transform: scale(1.1); }
 .loader-bubble { width: 30px; height: 10px; display: flex;
align-items: center; justify-content: space-around; }
 .loader-dot { width: 6px; height: 6px; background: var(--accent);
border-radius: 50%; animation: loading 1.4s infinite ease-in-out both; }
 .loader-dot:nth-child(1) { animation-delay: -0.32s; }
 .loader-dot:nth-child(2) { animation-delay: -0.16s; }
 @keyframes loading { 0%, 80%, 100% { transform: scale(0); } 40% {
transform: scale(1.0); } }
 @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to
{ opacity: 1; transform: translateY(0); } }
 @keyframes fadeInRight { from { opacity: 0; transform: translateX(10px);
} to { opacity: 1; transform: translateX(0); } }
 .uplink-gate { position: fixed; inset: 0; background: #000; z-index:
9999; display: flex; flex-direction: column; align-items: center;
justify-content: center; font-family: 'Space Grotesk', monospace; color: #fff;
transition: opacity 0.5s; }
 .gate-ring { width: 50px; height: 50px; border: 2px solid
rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%;
animation: rotate 1s infinite linear; }
 @keyframes rotate { from { transform: rotate(0deg); } to { transform:
rotate(360deg); } }
</style>
</head>
<body>
 <div class="aether-void"></div>
 <div class="noise-overlay"></div>
 <div class="uplink-gate"
id="uplinkGate"><div
class="gate-ring"></div><div
style="margin-top:20px; letter-spacing: 3px; font-size:
12px;">ESTABLISHING UPLINK...</div></div>

 <div class="hud-top">
   <div class="brand-logo"><div
class="status-light"></div><span
id="brandNameDisplay">YOYI</span></div>
   <div class="nav-actions">
     <a href="#" class="nav-btn"
id="phoneLink"><i class="fas
fa-phone-alt"></i></a>
     <a href="#" class="nav-btn"
id="mailLink"><i class="fas
fa-envelope"></i></a>
     <a href="#" class="nav-btn"
id="socialLink"><i class="fas
fa-share-alt"></i></a>
   </div>
 </div>

 <div class="stream-viewport"
id="chatStream">
   <div class="bot-msg">
     <div class="welcome-msg">Hi, I am YOYI.</div>
     <div class="bot-text"
id="welcomeMsgDisplay">系統初始化中...</div>
     <div class="qa-prompt">QUICK ACCESS (快速提問)</div>
     <div class="qa-deck"
id="qaDeck"></div>
   </div>
 </div>

 <div class="input-hud">
   <input type="text" class="chat-input"
id="chatInput" placeholder="輸入你的提問...">
   <button class="send-btn"
id="sendBtn"
onclick="handleUserInput()"><i class="fas
fa-arrow-up"></i></button>
 </div>
<script>
const supabaseUrl =
'https://skkjzquxollefddyhtxt.supabase.co';
const supabaseKey =
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNra2p6cXV4b2xsZWZkZHlodHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTQ4NzMsImV4cCI6MjA4MDA3MDg3M30.S0tcaKijsb-rrJuZWeBn9uUr8geu63qKNa-cdgjS12I';
const supabaseClient =
supabase.createClient(supabaseUrl, supabaseKey);
let currentUserId =
null; let currentProfile = null; let qaRules = [];
const themes = {
 pc_repair: { name: "TECH // GREEN", color: "#00f260", vars: {
"--aurora-1": "#00f260", "--aurora-2":
"#0575e6", "--aurora-3": "#00f260",
"--accent": "#00f260", "--glow": "rgba(0,
242, 96, 0.4)" } },
 restaurant: { name: "FOOD // ORANGE", color: "#ff9068", vars: {
"--aurora-1": "#ff416c", "--aurora-2":
"#ff4b1f", "--aurora-3": "#ff9068",
"--accent": "#ff9068", "--glow": "rgba(255,
144, 104, 0.4)" } },
 beauty: { name: "VOGUE // PURPLE", color: "#da77f2", vars: {
"--aurora-1": "#833ab4", "--aurora-2":
"#fd1d1d", "--aurora-3": "#fcb045",
"--accent": "#da77f2", "--glow": "rgba(218,
119, 242, 0.4)" } },
 real_estate: { name: "ESTATE // GOLD", color: "#F3F9A7", vars: {
"--aurora-1": "#CAC531", "--aurora-2":
"#F3F9A7", "--aurora-3": "#8E8D8A",
"--accent": "#F3F9A7", "--glow": "rgba(243,
249, 167, 0.4)" } },
 gym: { name: "GYM // LIME", color: "#38ef7d", vars: { "--aurora-1":
"#11998e", "--aurora-2": "#38ef7d",
"--aurora-3": "#000000", "--accent": "#38ef7d",
"--glow": "rgba(56, 239, 125, 0.4)" } },
 car: { name: "AUTO // STEEL", color: "#4CA1AF", vars: { "--aurora-1":
"#2C3E50", "--aurora-2": "#4CA1AF",
"--aurora-3": "#C4E0E5", "--accent": "#4CA1AF",
"--glow": "rgba(76, 161, 175, 0.4)" } },
 shop: { name: "SHOP // RED", color: "#FF512F", vars: { "--aurora-1":
"#FF512F", "--aurora-2": "#DD2476",
"--aurora-3": "#FF512F", "--accent": "#FF512F",
"--glow": "rgba(255, 81, 47, 0.4)" } },
 clinic: { name: "MED // BLUE", color: "#00d2ff", vars: { "--aurora-1":
"#00d2ff", "--aurora-2": "#3a7bd5",
"--aurora-3": "#00d2ff", "--accent": "#00d2ff",
"--glow": "rgba(0, 210, 255, 0.4)" } },
 plumbing: { name: "FIX // CYAN", color: "#26D0CE", vars: {
"--aurora-1": "#1A2980", "--aurora-2":
"#26D0CE", "--aurora-3": "#1A2980",
"--accent": "#26D0CE", "--glow": "rgba(38,
208, 206, 0.4)" } },
 tutor: { name: "STUDY // VIOLET", color: "#8E54E9", vars: {
"--aurora-1": "#4776E6", "--aurora-2":
"#8E54E9", "--aurora-3": "#4776E6",
"--accent": "#8E54E9", "--glow": "rgba(142,
84, 233, 0.4)" } }
};

window.onload = function() {
   const urlParams = new URLSearchParams(window.location.search);
   currentUserId = urlParams.get('id');
   if (!currentUserId) {
       alert('錯誤：缺少使用者 ID 參數。請確認連結是否正確。');
       document.getElementById('uplinkGate').style.display = 'none';
       return;
   }
   init();
};

async function init() {
   try {
       await loadProfile();
       await loadQnARules();
       renderQAButtons();
       document.getElementById('uplinkGate').style.opacity = 0;
       setTimeout(() => { document.getElementById('uplinkGate').style.display = 'none'; }, 500);
       
       // 啟用鍵盤事件
       document.getElementById('chatInput').addEventListener('keypress', function(e) {
           if (e.key === 'Enter') handleUserInput('input');
       });
    } catch (error) {
       console.error('初始化失敗:', error);
       document.getElementById('welcomeMsgDisplay').innerText = '載入錯誤，請稍後再試。';
       document.getElementById('uplinkGate').style.display = 'none';
    }
}

async function loadProfile() {
   const { data, error } = await
supabaseClient.from('profiles').select('*').eq('id',
currentUserId).single();
   if (error) throw new Error('無法載入分身資料');
   currentProfile = data;
   
   // 應用視覺風格
   applyVisualsByColor(currentProfile.theme_color || themes.pc_repair.color);

   // 填充 HUD
   document.title = `${currentProfile.brand_name} | YOYI`;
   document.getElementById('brandNameDisplay').innerText =
currentProfile.brand_name || 'YOYI';
   document.getElementById('welcomeMsgDisplay').innerText =
currentProfile.welcome_msg || '你好，我是你的 AI 助理，請問有什麼我可以幫你的？';

   // 設置聯絡連結
   document.getElementById('phoneLink').href =
currentProfile.link_phone ? `tel:${currentProfile.link_phone}` : '#';
   document.getElementById('phoneLink').style.display =
currentProfile.link_phone ? 'flex' : 'none';
   document.getElementById('mailLink').href =
currentProfile.link_mail ? `mailto:${currentProfile.link_mail}` : '#';
   document.getElementById('mailLink').style.display =
currentProfile.link_mail ? 'flex' : 'none';
   
   // 社交連結整合到一個按鈕，讓畫面更簡潔
   const hasSocial = currentProfile.link_line || currentProfile.link_ig ||
currentProfile.link_fb || currentProfile.link_threads;
   document.getElementById('socialLink').style.display = hasSocial ? 'flex'
: 'none';
   document.getElementById('socialLink').onclick = (e) => {
     e.preventDefault();
     let socialList = '聯絡我們 (Contact Links):\n';
     if(currentProfile.link_line) socialList += `- LINE ID: ${currentProfile.link_line}\n`;
     if(currentProfile.link_ig) socialList += `- IG: ${currentProfile.link_ig}\n`;
     if(currentProfile.link_fb) socialList += `- FB: ${currentProfile.link_fb}\n`;
     if(currentProfile.link_threads) socialList += `- Threads: ${currentProfile.link_threads}\n`;
     alert(socialList);
   };
}

function applyVisualsByColor(color) {
   const root = document.documentElement;
   let selectedTheme = null;
   for (const key in themes) {
     if (themes[key].color === color) {
       selectedTheme = themes[key];
       break;
     }
   }

   // 如果找不到主題，使用預設綠色
   if (!selectedTheme) selectedTheme = themes.pc_repair; 

   for (const [k, v] of Object.entries(selectedTheme.vars)) {
     root.style.setProperty(k, v);
   }
}

async function loadQnARules() {
   const { data, error } = await
supabaseClient.from('qna_rules').select('question, answer').eq('user_id',
currentUserId).order('created_at', {ascending: false});
   if (error) throw new Error('無法載入問答規則');
   qaRules = data;
}

function renderQAButtons() {
   const deck = document.getElementById('qaDeck');
   deck.innerHTML = '';
   qaRules.forEach((rule, index) => {
       const btn = document.createElement('button');
       btn.className = 'qa-btn';
       btn.innerText = rule.question;
       btn.onclick = () => handleUserInput('button', index);
       deck.appendChild(btn);
   });
}

async function handleUserInput(type = 'input', ruleIndex = -1) {
   const chatInput = document.getElementById('chatInput');
   let userMessage = '';
   let botResponse = '';
   const rule = ruleIndex !== -1 ? qaRules[ruleIndex] : null;

   if (type === 'button' && rule) {
       userMessage = rule.question;
       botResponse = rule.answer;
   } else if (type === 'input') {
       userMessage = chatInput.value.trim();
       if (userMessage === '') return;
       
       // 尋找匹配的 Q&A 規則
       const matchedRule = qaRules.find(r => userMessage.includes(r.question));
       if (matchedRule) {
           botResponse = matchedRule.answer;
           // 更新點擊數
           await
supabaseClient.from('qna_rules').update({ click_count:
(matchedRule.click_count || 0) + 1 }).eq('question',
matchedRule.question).eq('user_id', currentUserId);
       } else {
           // 預設回應邏輯（可在此處接入 LLM API）
           botResponse = "很抱歉，我還沒有針對這個問題進行訓練。請嘗試點擊快速提問按鈕。";
       }
       chatInput.value = ''; // 清空輸入框
   } else {
       return;
   }

   // 顯示使用者訊息
   appendMessage(userMessage, 'user');

   // 顯示機器人回應
   await showBotResponse(botResponse, type, userMessage);
}

function appendMessage(text, sender) {
   const stream = document.getElementById('chatStream');
   const msgDiv = document.createElement('div');
   msgDiv.className = sender === 'bot' ? 'bot-msg' : 'user-msg';
   if (sender === 'bot') {
       msgDiv.innerHTML = `<div class="bot-text">${text}</div>`;
   } else {
       msgDiv.innerText = text;
   }
   stream.appendChild(msgDiv);
   stream.scrollTop = stream.scrollHeight; // 滾動到底部
}

async function showBotResponse(botResponse, type, userMessage) {
   const stream = document.getElementById('chatStream');
   const loadingDiv = document.createElement('div');
   loadingDiv.className = 'bot-msg';
   loadingDiv.style.opacity = 0.5;
   loadingDiv.innerHTML = `<div
class="loader-bubble"><div
class="loader-dot"></div><div
class="loader-dot"></div><div
class="loader-dot"></div></div>`;
   stream.appendChild(loadingDiv);
   stream.scrollTop = stream.scrollHeight;

   await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 500)); // 模擬延遲

   loadingDiv.remove();
   appendMessage(botResponse, 'bot');
   
   // 記錄 Chat Log
   await
supabaseClient.from('chat_logs').insert([{
user_id: currentUserId, message: userMessage, bot_response:
botResponse, type: type }]);
}
</script>
</body>
</html>