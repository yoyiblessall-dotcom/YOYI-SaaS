<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<title>YOYI | Digital Twin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* =========================================
     CORE AESTHETICS (‰øùÁïô‰Ω†ÁöÑÂéüÂßãË®≠Ë®à)
     ========================================= */
  :root {
    --accent: #00f260; 
    --glow: rgba(0, 242, 96, 0.4);
    --bg-deep: #000;
    --glass: rgba(255, 255, 255, 0.05);
    --border: rgba(255, 255, 255, 0.15);
    --aurora-1: #00f260; 
    --aurora-2: #0575e6; 
    --aurora-3: #00f260;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0; padding: 0;
    font-family: 'Space Grotesk', -apple-system, "Microsoft JhengHei", sans-serif;
    background-color: var(--bg-deep);
    color: #fff;
    height: 100dvh; 
    width: 100vw;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* ËÉåÊôØÂãïÊïà */
  .aether-void {
    position: absolute; inset: -50%;
    background: conic-gradient(
      from 0deg, transparent 0deg, var(--aurora-1) 60deg, transparent 120deg, var(--aurora-2) 180deg, transparent 240deg, var(--aurora-3) 300deg, transparent 360deg
    );
    filter: blur(90px); opacity: 0.35;
    animation: rotateVoid 30s linear infinite; z-index: -1; transition: all 2s ease;
  }
  .noise-overlay {
    position: absolute; inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: -1;
  }
  @keyframes rotateVoid { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* HUD È†ÇÈÉ®Â∞éËà™ */
  .hud-top {
    flex: 0 0 auto; 
    padding: calc(20px + env(safe-area-inset-top)) 24px 20px 24px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    backdrop-filter: blur(10px); z-index: 10;
  }
  .brand-logo { font-size: 16px; letter-spacing: 1px; font-weight: 700; color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 10px; }
  .status-light { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 2s infinite; }
  
  .nav-actions { display: flex; gap: 12px; }
  .nav-btn {
    background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: rgba(255,255,255,0.9);
    text-decoration: none; font-size: 14px; width: 36px; height: 36px; 
    display: flex; align-items: center; justify-content: center; 
    border-radius: 50%; transition: 0.3s;
  }
  .nav-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--glow); transform: scale(1.1); }

  /* Â∞çË©±ÂçÄÂ°ä */
  .stream-viewport {
    flex: 1; overflow-y: auto; padding: 30px 24px;
    display: flex; flex-direction: column; gap: 24px;
    mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
    scroll-behavior: smooth;
  }
  .node { display: flex; flex-direction: column; max-width: 88%; animation: driftUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
  .node.bot { align-self: flex-start; border-left: 2px solid var(--accent); padding-left: 18px; }
  .node.user { align-self: flex-end; align-items: flex-end; border-right: 2px solid rgba(255,255,255,0.3); padding-right: 18px; }
  .node-text { font-size: 15px; line-height: 1.6; font-weight: 400; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
  .node.bot .node-text { color: rgba(255,255,255,0.95); }
  .node.user .node-text { color: var(--accent); text-align: right; }

  /* Á≥ªÁµ±ÊèêÁ§∫Ë®äÊÅØ */
  .node.sys-msg .node-text {
    color: #00ffff;
    font-size: 13px; font-weight: 500;
    border-left: 2px solid #00ffff; padding-left: 12px;
    background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
    border-radius: 0 4px 4px 0; line-height: 1.6; letter-spacing: 0.5px;
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
  }

  /* Â∫ïÈÉ®Êìç‰ΩúÂçÄ */
  .monolith-dock {
    flex: 0 0 auto; 
    padding: 0 0 calc(20px + env(safe-area-inset-bottom)) 0;
    background: linear-gradient(to top, #000 20%, rgba(0,0,0,0.8) 80%, transparent);
    display: flex; flex-direction: column; gap: 15px; z-index: 20;
    position: relative;
  }

  .orbit-wrapper { position: relative; width: 100%; display: flex; align-items: center; height: 50px; }
  .orbit-bar {
    display: flex; gap: 10px; overflow-x: auto; padding: 0 24px;
    scrollbar-width: none; flex: 1; scroll-behavior: smooth;
    align-items: center; height: 100%; padding-right: 60px;
  }
  .orbit-bar::-webkit-scrollbar { display: none; }

  .orbit-chip {
    flex: 0 0 auto; height: 38px; padding: 0 18px;
    background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(255,255,255,0.4);
    color: #ffffff; font-size: 14px; letter-spacing: 1px; font-weight: 600;
    cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px); 
    white-space: nowrap; font-family: inherit; border-radius: 6px; 
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  .orbit-chip:hover, .orbit-chip:active {
    border-color: var(--accent); color: #000; background: var(--accent);
    box-shadow: 0 0 20px var(--glow); font-weight: 700;
  }

  .scroll-btn-right {
    position: absolute; right: 0; top: 0; bottom: 0; 
    width: 70px; background: linear-gradient(to left, #000 30%, transparent); 
    display: flex; align-items: center; justify-content: center;
    z-index: 30; cursor: pointer; pointer-events: auto; display: none; 
  }
  .scroll-circle {
      width: 36px; height: 36px; border-radius: 50%; 
      background: rgba(0, 0, 0, 0.9); border: 2px solid var(--accent); color: var(--accent);
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(5px); box-shadow: 0 0 15px var(--glow); font-size: 16px;
      animation: pulseGlow 1.5s infinite alternate;
  }
  @keyframes pulseGlow {
    0% { box-shadow: 0 0 5px var(--glow); transform: scale(1); }
    100% { box-shadow: 0 0 20px var(--accent), 0 0 10px #fff; transform: scale(1.1); }
  }

  .core-input-wrapper {
    margin: 0 24px; height: 50px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; gap: 15px; transition: 0.3s;
  }
  .core-input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
  .transmit-btn { background: transparent; border: none; color: rgba(255,255,255,0.5); font-size: 14px; cursor: pointer; font-weight: 500;}
  .transmit-btn:hover { color: var(--accent); }

  @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
  @keyframes driftUp { from { opacity: 0; transform: translateY(20px); filter: blur(5px); } to { opacity: 1; transform: translateY(0); filter: blur(0); } }

  /* ÁôªÂÖ•ÈñòÈÅì */
  #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2147483647; display: none; justify-content: center; align-items: center; flex-direction: column; }
  .login-box { width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-radius: 20px; padding: 40px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); }
  .login-title { color: #fff; font-size: 20px; margin-bottom: 20px; letter-spacing: 2px; }
  .login-input { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #00ff88; font-family: monospace; text-align: center; font-size: 16px; border-radius: 10px; margin-bottom: 20px; outline: none; }
  .login-btn { padding: 12px 30px; background: #00ff88; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
  
  /* ÈñãÊ©üÂãïÁï´Â±§ */
  .boot-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Space Grotesk', monospace; transition: opacity 1s ease; }
  .glitch-text { font-size: 26px; letter-spacing: 3px; color: #fff; animation: glitch 1s infinite; }
  @keyframes glitch { 0% { opacity: 1; } 50% { opacity: 0.8; text-shadow: 2px 0 red, -2px 0 blue; } 100% { opacity: 1; } }
</style>
</head>
<body>

<!-- ÁôªÂÖ•ÈñòÈÅì -->
<div id="loginOverlay">
    <div class="login-box">
        <div class="login-title">SYSTEM LOGIN</div>
        <p style="color:#888; font-size:12px; margin-bottom:20px;">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁ≥ªÁµ± ID (Access Token)</p>
        <input type="text" id="unique_gate_input" class="login-input" placeholder="Paste ID Here...">
        <button class="login-btn" onclick="executeFinalLogin()">ENTER SYSTEM</button>
    </div>
</div>

<script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentId = urlParams.get('id');
        const overlay = document.getElementById('loginOverlay');
        if (currentId) {
            if (overlay) overlay.remove();
        } else {
            if (overlay) {
                overlay.style.display = 'flex'; 
                const myInput = document.getElementById('unique_gate_input');
                if (myInput) {
                    myInput.addEventListener("keypress", function(event) {
                        if (event.key === "Enter") { event.preventDefault(); executeFinalLogin(); }
                    });
                    setTimeout(() => myInput.focus(), 100); 
                }
            }
            const style = document.createElement('style');
            style.innerHTML = `body > *:not(#loginOverlay):not(script) { display: none !important; }`;
            document.head.appendChild(style);
        }
    })();

    function executeFinalLogin() {
        const inputEl = document.getElementById('unique_gate_input');
        if (!inputEl) return;
        const finalVal = inputEl.value.trim();
        if (finalVal && finalVal.length > 5) window.location.href = window.location.pathname + '?id=' + finalVal;
        else alert("ÈåØË™§ÔºöID ÁÑ°ÊïàÔºÅ");
    }
</script>

<div class="aether-void" id="aetherBg"></div>
<div class="noise-overlay"></div>

<!-- ÈñãÊ©üÁï´Èù¢ - Êõ¥Êñ∞ÂìÅÁâåÊñáÂ≠ó (Steve Jobs Update) -->
<div class="boot-screen" id="bootLayer">
  <div class="glitch-text">YOYI SYSTEM</div>
  <div style="margin-top:20px; font-size:12px; color:#666; letter-spacing:1px;" id="bootStatus">CONNECTING DIGITAL TWIN...</div>
</div>

<!-- È†ÇÈÉ® HUD (Translation Fix Included) -->
<div class="hud-top">
  <div class="brand-logo notranslate" translate="no">
    <div class="status-light" id="statusLight"></div>
    <span id="brandTitle">SYSTEM STANDBY</span>
  </div>
  <div class="nav-actions" id="socialDeck"></div>
</div>

<!-- Â∞çË©±Ë¶ñÁ™ó -->
<div class="stream-viewport" id="chatBody"></div>

<!-- Â∫ïÈÉ®Êìç‰ΩúÂçÄ -->
<div class="monolith-dock">
  <div class="orbit-wrapper">
    <div class="orbit-bar" id="quickActions"></div>
    <div class="scroll-btn-right" id="scrollArrow" onclick="scrollMenu()">
        <div class="scroll-circle">
            <i class="fas fa-chevron-right"></i>
        </div>
    </div>
  </div>
  <div class="core-input-wrapper">
    <input type="text" class="core-input" id="userInput" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..." autocomplete="off">
    <button class="transmit-btn" onclick="handleSend()">ÈÄÅÂá∫</button>
  </div>
</div>

<script>
// ========================================================
// Ë®≠ÂÆöËàá Supabase ÈÄ£Á∑ö
// ========================================================
const supabaseUrl = 'https://skkjzquxollefddyhtxt.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNra2p6cXV4b2xsZWZkZHlodHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTQ4NzMsImV4cCI6MjA4MDA3MDg3M30.S0tcaKijsb-rrJuZWeBn9uUr8geu63qKNa-cdgjS12I';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const urlParams = new URLSearchParams(window.location.search);
const CLIENT_ID = urlParams.get('id');
let currentQnA = [];

// ========================================================
// ‰∫∫Ê†ºÂºïÊìéÔºöÈö®Ê©üË™ûÈåÑÂ∫´ (Warm & Humorous Fallback)
// ========================================================
const fallbackMessages = [
    "ÈÄôÂÄãÂïèÈ°åÊàëÈÇÑÊ≤íË¢´„ÄåÊú¨Â∞ä„ÄçËº∏ÂÖ•Ë®òÊÜ∂... üòÖ ‰ΩÜÊàëÂ∑≤Á∂ìÊää‰Ω†ÊâìÁöÑÂÖßÂÆπË®ò‰∏ã‰æÜ‰∫ÜÔºÅ‰∏ãÊ¨°Ë™™‰∏çÂÆöÂ∞±ÊúÉÊúâÈÄôÂÄãÊåâÈàïÂõâÔºÅ",
    "ÂìáÔºåÈÄôÈ°åË∂ÖÂá∫‰∫ÜÊàëÁöÑË≥áÊñôÂ∫´ÔºÅüìÇ ÊàëÊääÈÄôÂè•Ë©±Â≠òÂÖ•ÂæåÂè∞‰∫ÜÔºåÊôöÈªûËÆìÊàëÁöÑÁúüÂØ¶Ë∫´ÂàÜË¶™Ëá™‰æÜÁúã„ÄÇ",
    "ÊàëÊòØ‰ªñÁöÑ AI ÂàÜË∫´ÔºåÈÄôÈ°åÊúâÈªûÂ§™Ê∑±Â•ß‰∫ÜÔºÅü§ñ Âª∫Ë≠∞‰Ω†ÂÖàÈªûÈªûÁúã‰∏ãÊñπÁöÑÊåâÈàïÔºåÈÇ£ÊòØ‰ªñÊúÄÊÉ≥Ë∑ü‰Ω†ÂàÜ‰∫´ÁöÑ‰∫ã„ÄÇ",
    "ÊàëÁúã‰∏çÂ§™ÊáÇÈÄôÂÄãÈóúÈçµÂ≠ó... ü§î ‰∏çÈÅéÊ≤íÈóú‰øÇÔºå‰Ω†ÁöÑÁïôË®ÄÊàëÊî∂Âà∞‰∫ÜÔºÅÈÄôÊúÉÂπ´Âä©ÊàëËÆäÂæóÊõ¥ËÅ∞Êòé„ÄÇ",
    "ÈÄôÂÄãË©±È°åÂæàÊúâË∂£ÔºÅ‰ΩÜÊàëÁõÆÂâçÂè™ÊáÇ‰∏ãÊñπÊåâÈàïÁöÑÂÖßÂÆπ„ÄÇüëá Ë¶Å‰∏çË¶ÅÂÖàÁúãÁúãÈÇ£ÈÇäÔºüÊàñËÄÖÁõ¥Êé•Èªû‰∏äÊñπÈÄ£ÁµêÊâæÊàëÁöÑÊú¨Â∞äÔºü",
    "Êä±Ê≠âÔºåÊàëÁöÑÂ§ßËÖ¶ÈÇÑÂú®Êì¥ÂÖÖ‰∏≠... ‚ö° ‰Ω†ÁöÑËº∏ÂÖ•Â∑≤Á∂ìÊàêÁÇ∫ÊàëÁöÑÂ≠∏ÁøíÈ§äÂàÜÔºÅÂ¶ÇÊûúÊúâÊÄ•‰∫ãÔºåË´ãÁõ¥Êé•Êåâ‰∏äÊñπÁöÑÈõªË©±Êàñ LINE ÂñîÔºÅ",
    "ÂòøÔºÅÈÄôÈ°åÊàëÁ≠î‰∏çÂá∫‰æÜ üòÇ„ÄÇ‰ΩÜÊàëËÄÅÈóÜÔºà‰πüÂ∞±ÊòØÊàëÊú¨Â∞äÔºâÁ®çÂæåÊúÉÂú®ÂæåÂè∞ÁúãÂà∞‰Ω†Âïè‰∫ÜÈÄôÂÄãÔºåÊúüÂæÖ‰ªñÊõ¥Êñ∞Á≠îÊ°àÂêßÔºÅ",
    "Áúã‰æÜ‰Ω†Â∞çÈÄôÂÄãÂæàÊúâËààË∂£ÔºÅüëÄ ÈõñÁÑ∂ÊàëÁèæÂú®ÁÑ°Ê≥ïÂõûÁ≠îÔºå‰ΩÜ‰Ω†ÂèØ‰ª•Ë©¶Ë©¶ÁúãÊªëÂãï‰∏ãÊñπÁöÑÊåâÈàïÔºå‰πüË®±ÊúâÈ°û‰ººÁöÑÈ©öÂñúÔºü"
];

// ========================================================
// ÂàùÂßãÂåñ (Steve Jobs Update: Speed Optimization)
// ========================================================
async function init() {
  if (!CLIENT_ID) return;

  try {
    document.getElementById('bootStatus').innerText = "SYNCING DATA...";
    
    // ËÆÄÂèñË®≠ÂÆö
    const { data: profile, error: err1 } = await supabaseClient.from('profiles').select('*').eq('id', CLIENT_ID).single();
    if (err1 || !profile) throw new Error("ACCESS DENIED");

    // ËÆÄÂèñÂïèÁ≠î
    const { data: rules, error: err2 } = await supabaseClient.from('qna_rules').select('*').eq('user_id', CLIENT_ID).order('created_at', {ascending: true});
    currentQnA = rules || [];

    applyTheme(profile);
    renderSocials(profile);
    updateOrbit(currentQnA);

    // [SPEED FIX] Âä†Âø´ÈÄ≤ÂÖ•ÈÄüÂ∫¶
    setTimeout(() => {
        document.getElementById("bootLayer").style.opacity = 0;
        // Á∏ÆÁü≠ËΩâÂ†¥Á≠âÂæÖ
        setTimeout(()=> document.getElementById("bootLayer").style.display = "none", 500);
        setTimeout(() => { 
            // Â¶ÇÊûúÊúâÊ≠°ËøéË™ûÂ∞±Áî®Ê≠°ËøéË™ûÔºåÊ≤íÊúâÂ∞±Áî®È†êË®≠
            addNode("bot", profile.welcome_msg || "SYSTEM READY."); 
        }, 300); // Á∏ÆÁü≠Ê≠°ËøéË™ûÂª∂ÈÅ≤
    }, 800); // Á∏ÆÁü≠ÂàùÂßãÁ≠âÂæÖ (Âéü 1500)

  } catch (e) {
    console.error(e);
    document.querySelector('.glitch-text').innerText = "CONNECTION_LOST";
    document.querySelector('.glitch-text').style.color = "#ff3b30";
  }
}

function applyTheme(profile) {
  document.getElementById('brandTitle').innerText = profile.brand_name || "STANDALONE";
  document.title = `${profile.brand_name || 'YOYI'} | AI`;
  const root = document.documentElement;
  // Â¶ÇÊûúË≥áÊñôÂ∫´ÊúâÈ°èËâ≤Â∞±Áî®ÔºåÊ≤íÊúâÂ∞±Áî®È†êË®≠Á∂†
  const color = profile.theme_color || '#00f260';
  root.style.setProperty('--accent', color);
  root.style.setProperty('--glow', color);
  root.style.setProperty('--aurora-1', color);
  document.getElementById("statusLight").style.backgroundColor = color;
  document.getElementById("statusLight").style.boxShadow = `0 0 10px ${color}`;
}

// ‰øÆÊ≠£ÂæåÁöÑÁ§æÁæ§ÂúñÊ®ôÊ∏≤Êüì (ÊîØÊè¥ LINE ID Âà§Êñ∑)
function renderSocials(profile) {
    const deck = document.getElementById('socialDeck'); deck.innerHTML = '';
    
    // ÂÆöÁæ©ÈÄ£ÁµêËàáÈ°ûÂûã
    const links = [
        { icon: 'fas fa-phone', val: profile.link_phone, type: 'tel' },
        { icon: 'fas fa-envelope', val: profile.link_mail, type: 'mailto' },
        { icon: 'fab fa-line', val: profile.link_line, type: 'line' },
        { icon: 'fab fa-instagram', val: profile.link_ig, type: 'ig' },
        { icon: 'fab fa-facebook-f', val: profile.link_fb, type: 'fb' },
        { icon: 'fas fa-at', val: profile.link_threads, type: 'threads' }
    ];

    links.forEach(link => {
        if (link.val) {
            const a = document.createElement('a'); a.className = 'nav-btn';
            let href = link.val.trim(); 
            
            // Êô∫ÊÖßÈÄ£ÁµêËΩâÊèõ
            if (link.type === 'tel') href = `tel:${href}`;
            else if (link.type === 'mailto') href = `mailto:${href}`;
            else if (link.type === 'line') {
                if (href.startsWith('http')) {} 
                else if (href.startsWith('@')) href = `https://line.me/R/ti/p/${href}`;
                else href = `https://line.me/ti/p/~${href}`;
            }
            else if (link.type === 'ig' && !href.startsWith('http')) href = `https://www.instagram.com/${href.replace('@', '')}`;
            else if (link.type === 'fb' && !href.startsWith('http')) href = `https://www.facebook.com/${href}`;
            else if (link.type === 'threads' && !href.startsWith('http')) href = `https://www.threads.net/@${href.replace('@', '')}`;
            else if (!href.startsWith('http') && link.type !== 'tel' && link.type !== 'mailto') href = `https://${href}`;

            a.href = href; 
            a.target = '_blank';
            a.innerHTML = `<i class="${link.icon}"></i>`;
            deck.appendChild(a);
        }
    });
}

// ‰øÆÊ≠£ÂæåÁöÑÊåâÈàïÂàó
function updateOrbit(faqs) {
  const bar = document.getElementById("quickActions"); bar.innerHTML = "";
  const arrow = document.getElementById("scrollArrow");

  if(faqs && faqs.length > 0) {
    faqs.forEach(item => {
      const chip = document.createElement("button"); chip.className = "orbit-chip";
      chip.innerText = item.question;
      // ÈªûÊìä‰∫ã‰ª∂ÔºöÂëºÂè´ handleInput
      chip.onclick = () => handleInput(item.question, item.answer, item.id);
      bar.appendChild(chip);
    });

    // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈ°ØÁ§∫ÁÆ≠È†≠
    setTimeout(() => {
        if(bar.scrollWidth > bar.clientWidth) arrow.style.display = "flex";
        else arrow.style.display = "none";
    }, 100);
  } else {
     arrow.style.display = "none";
  }
}

// Êç≤ÂãïÂäüËÉΩ
function scrollMenu() {
    const bar = document.getElementById("quickActions");
    bar.scrollBy({ left: 150, behavior: 'smooth' });
}
document.getElementById("quickActions").addEventListener("scroll", function() {
   const bar = this;
   const arrow = document.getElementById("scrollArrow");
   if(bar.scrollLeft + bar.clientWidth >= bar.scrollWidth - 10) {
       arrow.style.opacity = "0"; arrow.style.pointerEvents = "none";
   } else {
       arrow.style.opacity = "1"; arrow.style.pointerEvents = "auto";
   }
});

// ========================================================
// ‰∫íÂãïËôïÁêÜ
// ========================================================
async function logToCloud(msg, response, type) {
    if (!CLIENT_ID) return;
    // ÂØ´ÂÖ•Â∞çË©±Á¥ÄÈåÑ
    const { error } = await supabaseClient.from('chat_logs').insert([
        { user_id: CLIENT_ID, message: msg, bot_response: response, type: type }
    ]);
    if(error) console.error("Log Error:", error);
}

async function handleInput(q, a, id) {
  addNode("user", q);
  showProcessing();
  
  // 1. ÈªûÊìäÊ¨°Êï∏Âä†ÂàÜ (Â¶ÇÊûú id Â≠òÂú®)
  if (id && CLIENT_ID) {
      // ÂÖàËÆÄÂèñÁõÆÂâçÁöÑ click_count
      const { data: current } = await supabaseClient.from('qna_rules').select('click_count').eq('id', id).single();
      if (current) {
          // Êõ¥Êñ∞ click_count + 1
          await supabaseClient.from('qna_rules').update({ click_count: (current.click_count || 0) + 1 }).eq('id', id);
      }
  }
  
  // 2. ÂØ´ÂÖ• Log (type='button')
  logToCloud(q, a, 'button'); 
  
  setTimeout(() => { removeProcessing(); addNode("bot", a); }, 800);
}

function handleSend() {
  const input = document.getElementById("userInput"); const text = input.value.trim(); if(!text) return;
  addNode("user", text); input.value = ""; showProcessing();
  
  let ans = null; let isFallback = false;
  // Á∞°ÂñÆÈóúÈçµÂ≠óÊØîÂ∞ç
  if (currentQnA.length > 0) { 
      for(let f of currentQnA) { 
          if (f.question && text.includes(f.question)) { ans = f.answer; break; } 
      } 
  }
  // Ê≤íÂ∞ç‰∏≠ÔºåÈö®Ê©üÊåëÈÅ∏‰∏ÄÂè• Fallback
  if (!ans) { 
      const randomIndex = Math.floor(Math.random() * fallbackMessages.length); 
      ans = fallbackMessages[randomIndex]; 
      isFallback = true; 
  }
  
  // ÂØ´ÂÖ• Log (type='text')
  logToCloud(text, ans, 'text');

  setTimeout(() => { 
      removeProcessing(); 
      if (isFallback) { addNode("sys-msg", ans); } 
      else { addNode("bot", ans); } 
  }, 600); 
}

function addNode(role, text) {
  const body = document.getElementById("chatBody"); 
  const node = document.createElement("div"); 
  if (role === 'sys-msg') { node.className = `node bot sys-msg`; } 
  else { node.className = `node ${role}`; }
  
  node.innerHTML = `<div class="node-text">${text.replace(/\n/g, '<br>')}</div>`;
  body.appendChild(node); body.scrollTop = body.scrollHeight;
}

function showProcessing() { 
    const body = document.getElementById("chatBody"); 
    const node = document.createElement("div"); 
    node.id = "procNode"; node.className = "node bot"; 
    node.innerHTML = `<div class="node-text" style="opacity:0.6; font-size:12px; letter-spacing:1px;">COMPUTING...</div>`; 
    body.appendChild(node); body.scrollTop = body.scrollHeight; 
}

function removeProcessing() { const el = document.getElementById("procNode"); if(el) el.remove(); }

document.getElementById("userInput").addEventListener("keypress", (e) => { if(e.key==="Enter") handleSend(); });

init();
</script>
</body>
</html>