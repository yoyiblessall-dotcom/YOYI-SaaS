<script>
// ========================================================
// 1. 設定與 Supabase 連線
// ========================================================
const supabaseUrl = 'https://skkjzquxollefddyhtxt.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNra2p6cXV4b2xsZWZkZHlodHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTQ4NzMsImV4cCI6MjA4MDA3MDg3M30.S0tcaKijsb-rrJuZWeBn9uUr8geu63qKNa-cdgjS12I';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let USER_ID = 'your_fixed_user_id'; // <--- **重要：請在這裡填入你的固定 USER_ID！**
let currentProfile = {};
let currentQnaRules = [];
let currentLogs = [];
let isMobileView = window.innerWidth <= 1000; // 判斷是否為手機尺寸

// ========================================================
// 2. 主題定義（與 login.html 保持一致，但 Boss 端使用）
// ========================================================
const THEMES = {
    pc_repair: { name: "TECH // GREEN", color: "#00f260", vars: { "--aurora-1": "#00f260", "--aurora-2": "#0575e6", "--aurora-3": "#00f260", "--accent": "#00f260", "--glow": "rgba(0, 242, 96, 0.4)" } },
    restaurant: { name: "FOOD // ORANGE", color: "#ff9068", vars: { "--aurora-1": "#ff416c", "--aurora-2": "#ff4b1f", "--aurora-3": "#ff9068", "--accent": "#ff9068", "--glow": "rgba(255, 144, 104, 0.4)" } },
    beauty: { name: "VOGUE // PURPLE", color: "#da77f2", vars: { "--aurora-1": "#833ab4", "--aurora-2": "#fd1d1d", "--aurora-3": "#fcb045", "--accent": "#da77f2", "--glow": "rgba(218, 119, 242, 0.4)" } },
    real_estate: { name: "ESTATE // GOLD", color: "#F3F9A7", vars: { "--aurora-1": "#CAC531", "--aurora-2": "#F3F9A7", "--aurora-3": "#8E8D8A", "--accent": "#F3F9A7", "--glow": "rgba(243, 249, 167, 0.4)" } },
    gym: { name: "GYM // LIME", color: "#38ef7d", vars: { "--aurora-1": "#11998e", "--aurora-2": "#38ef7d", "--aurora-3": "#000000", "--accent": "#38ef7d", "--glow": "rgba(56, 239, 125, 0.4)" } },
    car: { name: "AUTO // STEEL", color: "#4CA1AF", vars: { "--aurora-1": "#2C3E50", "--aurora-2": "#4CA1AF", "--aurora-3": "#C4E0E5", "--accent": "#4CA1AF", "--glow": "rgba(76, 161, 175, 0.4)" } },
    shop: { name: "SHOP // RED", color: "#FF512F", vars: { "--aurora-1": "#FF512F", "--aurora-2": "#DD2476", "--aurora-3": "#FF512F", "--accent": "#FF512F", "--glow": "rgba(255, 81, 47, 0.4)" } },
    clinic: { name: "MED // BLUE", color: "#00d2ff", vars: { "--aurora-1": "#00d2ff", "--aurora-2": "#3a7bd5", "--aurora-3": "#00d2ff", "--accent": "#00d2ff", "--glow": "rgba(0, 210, 255, 0.4)" } },
    plumbing: { name: "FIX // CYAN", color: "#26D0CE", vars: { "--aurora-1": "#1A2980", "--aurora-2": "#26D0CE", "--aurora-3": "#1A2980", "--accent": "#26D0CE", "--glow": "rgba(38, 208, 206, 0.4)" } },
    tutor: { name: "STUDY // VIOLET", color: "#8E54E9", vars: { "--aurora-1": "#4776E6", "--aurora-2": "#8E54E9", "--aurora-3": "#4776E6", "--accent": "#8E54E9", "--glow": "rgba(142, 84, 233, 0.4)" } }
};

// ========================================================
// 3. 初始化與資料載入
// ========================================================
window.onload = function() {
    const bootLayer = document.getElementById('uplinkLayer');
    const urlParams = new URLSearchParams(window.location.search);
    const idParam = urlParams.get('id');

    if (idParam) {
        USER_ID = idParam; // 如果 URL 有 ID，則覆蓋
    } else {
        // 如果沒有 ID，導向登入頁面
        const currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl.replace('boss_editor.html', 'login.html');
        return;
    }
    
    document.getElementById('userIdDisplay').innerText = USER_ID;
    loadAllData();
    initUX();
    initPreview();

    // 隱藏開機動畫
    setTimeout(() => {
        bootLayer.style.opacity = 0;
        setTimeout(() => bootLayer.style.display = 'none', 500);
    }, 1200);
}

// 載入所有 Supabase 資料
async function loadAllData() {
    try {
        const [profileRes, qnaRes, logsRes] = await Promise.all([
            supabaseClient.from('profiles').select('*').eq('id', USER_ID).single(),
            supabaseClient.from('qna_rules').select('*').eq('user_id', USER_ID).order('created_at', { ascending: true }),
            supabaseClient.from('chat_logs').select('*').eq('user_id', USER_ID).order('created_at', { ascending: false }).limit(20)
        ]);

        if (profileRes.error || !profileRes.data) throw new Error("Profile Not Found");
        currentProfile = profileRes.data;
        currentQnaRules = qnaRes.data || [];
        currentLogs = logsRes.data || [];

        // 渲染所有區塊
        renderPreviewURL();
        renderSettingsForm();
        renderThemeSelector(currentProfile.theme_color);
        renderQnaEditor();
        renderChatLogs();
        renderDataInsight();
        updatePreviewIframe(); // 確保預覽框在資料載入後更新
        updateBossTheme(currentProfile.theme_color || THEMES.pc_repair.color);

    } catch (e) {
        console.error("Data Load Error:", e);
        alert('資料載入失敗，請檢查 User ID 或 Supabase 連線。');
    }
}

// ========================================================
// 4. UX 處理與導航
// ========================================================

// 初始化導航與手機切換
function initUX() {
    const navBtns = document.querySelectorAll('.dock-btn');
    const panels = document.querySelectorAll('.view-panel');
    const toggleBtn = document.getElementById('mobileToggleBtn');
    const layout = document.querySelector('.layout');

    // 導航切換
    navBtns.forEach(btn => {
        btn.onclick = function() {
            navBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            panels.forEach(p => p.classList.remove('active-panel'));
            document.getElementById(this.dataset.target).classList.add('active-panel');
            if (isMobileView) layout.style.transform = 'translateX(0)'; // 返回編輯頁
        };
    });
    // 預設啟動第一個按鈕
    if (navBtns.length > 0) navBtns[0].click();

    // 手機/預覽切換 (僅在手機尺寸下有用)
    toggleBtn.onclick = function() {
        isMobileView = window.innerWidth <= 1000;
        if (!isMobileView) return; // 桌面模式禁用
        
        if (layout.style.transform === 'translateX(-100vw)') {
            layout.style.transform = 'translateX(0)';
            this.innerHTML = '<i class="fas fa-mobile-alt"></i> 查看預覽';
        } else {
            layout.style.transform = 'translateX(-100vw)';
            this.innerHTML = '<i class="fas fa-edit"></i> 返回編輯';
        }
    };

    // 尺寸變動時重設佈局
    window.addEventListener('resize', () => {
        isMobileView = window.innerWidth <= 1000;
        if (!isMobileView) {
            layout.style.transform = 'translateX(0)';
            toggleBtn.style.display = 'none';
        } else {
            toggleBtn.style.display = 'flex';
        }
    });
    // 初始檢查
    if (isMobileView) toggleBtn.style.display = 'flex';
}

// 刷新預覽手機框
function updatePreviewIframe() {
    const iframe = document.getElementById('previewIframe');
    // 使用當前 URL + 帶上 USER_ID，確保 login.html 能正確讀取
    const loginUrl = window.location.href.replace('boss_editor.html', 'login.html');
    iframe.src = `${loginUrl}?id=${USER_ID}&t=${Date.now()}`;
}

// 初始化預覽
function initPreview() {
    const iframe = document.getElementById('previewIframe');
    // 當 iframe 載入完成，刷新 URL
    iframe.onload = function() {
        renderPreviewURL();
    };
}

// ========================================================
// 5. 區塊渲染與功能實現
// ========================================================

// 渲染預覽 URL (連結分享)
function renderPreviewURL() {
    const url = window.location.href.replace('boss_editor.html', 'login.html') + `?id=${USER_ID}`;
    document.getElementById('previewURL').value = url;
}

// 複製連結
function copyURL() {
    const urlInput = document.getElementById('previewURL');
    urlInput.select();
    document.execCommand('copy');
    alert('連結已複製到剪貼簿！');
}

// 渲染個人設定表單
function renderSettingsForm() {
    document.getElementById('brandName').value = currentProfile.brand_name || '';
    document.getElementById('welcomeMsg').value = currentProfile.welcome_msg || '';
    document.getElementById('linkPhone').value = currentProfile.link_phone || '';
    document.getElementById('linkMail').value = currentProfile.link_mail || '';
    document.getElementById('linkLine').value = currentProfile.link_line || '';
    document.getElementById('linkIg').value = currentProfile.link_ig || '';
    document.getElementById('linkFb').value = currentProfile.link_fb || '';
    document.getElementById('linkThreads').value = currentProfile.link_threads || '';
}

// 保存個人設定
async function saveProfile() {
    const updateData = {
        brand_name: document.getElementById('brandName').value,
        welcome_msg: document.getElementById('welcomeMsg').value,
        link_phone: document.getElementById('linkPhone').value,
        link_mail: document.getElementById('linkMail').value,
        link_line: document.getElementById('linkLine').value,
        link_ig: document.getElementById('linkIg').value,
        link_fb: document.getElementById('linkFb').value,
        link_threads: document.getElementById('linkThreads').value,
        updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient.from('profiles').update(updateData).eq('id', USER_ID);
    if (error) {
        alert(`保存失敗: ${error.message}`);
        console.error(error);
        return;
    }
    
    alert('基本設定已保存並更新預覽！');
    loadAllData(); // 重新載入並更新預覽
}

// 渲染主題選擇器
function renderThemeSelector(activeColor) {
    const colorGrid = document.getElementById('colorGrid');
    colorGrid.innerHTML = '';
    for (const key in THEMES) {
        const theme = THEMES[key];
        const orb = document.createElement('div');
        orb.className = 'color-orb';
        orb.style.backgroundColor = theme.color;
        orb.title = theme.name;
        if (theme.color === activeColor) {
            orb.classList.add('active');
        }
        orb.onclick = () => selectTheme(theme.color);
        colorGrid.appendChild(orb);
    }
}

// 選擇主題並保存
async function selectTheme(color) {
    // 1. 更新資料庫
    const { error } = await supabaseClient.from('profiles').update({ theme_color: color, updated_at: new Date().toISOString() }).eq('id', USER_ID);
    if (error) {
        alert('主題顏色更新失敗！');
        return;
    }
    
    // 2. 更新 Boss Editor 介面配色
    updateBossTheme(color);

    // 3. 更新主題選擇器樣式
    renderThemeSelector(color);

    // 4. 刷新預覽
    updatePreviewIframe();
}

// 動態更新 Boss Editor 自身的主題色
function updateBossTheme(color) {
    const root = document.documentElement;
    // 找到匹配的主題變數
    let selectedVars = THEMES.pc_repair.vars;
    for (const key in THEMES) {
        if (THEMES[key].color === color) {
            selectedVars = THEMES[key].vars;
            break;
        }
    }
    // 套用到 Boss Editor 的 CSS 變數上 (主要影響按鈕、邊框、光暈)
    root.style.setProperty('--accent', selectedVars['--accent']);
    root.style.setProperty('--glow', selectedVars['--glow']);
    root.style.setProperty('--aurora-1', selectedVars['--aurora-1']);
    root.style.setProperty('--aurora-2', selectedVars['--aurora-2']);
    root.style.setProperty('--aurora-3', selectedVars['--aurora-3']);

    // 更新 Boss 端的狀態燈號
    document.getElementById('bossDot').style.backgroundColor = selectedVars['--accent'];
    document.getElementById('bossDot').style.boxShadow = `0 0 10px ${selectedVars['--accent']}`;
}

// 渲染 Q&A 編輯器
function renderQnaEditor() {
    const editorBody = document.getElementById('qaEditorBody');
    editorBody.innerHTML = '';
    
    // 排序: 以點擊數遞減，建立時間遞增
    const sortedRules = [...currentQnaRules].sort((a, b) => {
        const countA = a.click_count || 0;
        const countB = b.click_count || 0;
        if (countA !== countB) return countB - countA;
        return new Date(a.created_at) - new Date(b.created_at);
    });
    
    sortedRules.forEach(rule => {
        const card = document.createElement('div');
        card.className = 'qa-card';
        card.innerHTML = `
            <div class="qa-header">
                <span class="qa-input-s">${rule.question}</span>
                <button class="btn-icon" onclick="deleteQna('${rule.id}')" title="刪除此規則"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="qa-body">
                <textarea data-id="${rule.id}" onchange="updateQnaAnswer('${rule.id}', this.value)" placeholder="輸入回應內容...">
                ${rule.answer}
                </textarea>
            </div>
            <div style="font-size:10px; color:#666; text-align:right; margin-top:10px;">點擊次數: ${rule.click_count || 0}</div>
        `;
        editorBody.appendChild(card);
    });
}

// 新增 Q&A 規則
async function addNewQna() {
    const qInput = document.getElementById('newQnaQuestion');
    const aInput = document.getElementById('newQnaAnswer');
    const q = qInput.value.trim();
    const a = aInput.value.trim();

    if (!q || !a) {
        alert('問題與答案都不能為空！');
        return;
    }

    const { error } = await supabaseClient.from('qna_rules').insert([
        { user_id: USER_ID, question: q, answer: a, click_count: 0 }
    ]);

    if (error) {
        alert(`新增 Q&A 失敗: ${error.message}`);
        return;
    }

    qInput.value = '';
    aInput.value = '';
    alert('新規則已新增，預覽已刷新！');
    loadAllData(); // 重新載入並更新編輯器與預覽
}

// 更新 Q&A 回答 (即時保存)
async function updateQnaAnswer(id, newAnswer) {
    const { error } = await supabaseClient.from('qna_rules').update({ answer: newAnswer, updated_at: new Date().toISOString() }).eq('id', id);
    if (error) {
        console.error('更新 Q&A 失敗:', error);
        // 可以考慮給予一個視覺上的失敗提示
        return;
    }
    // 提示用戶保存成功 (可以優化為更柔和的 Toast)
    console.log(`Q&A ID ${id} 已保存。`);
    updatePreviewIframe(); // 立即刷新預覽
}

// 刪除 Q&A 規則
async function deleteQna(id) {
    if (!confirm('確定要刪除這條 Q&A 規則嗎？')) return;

    const { error } = await supabaseClient.from('qna_rules').delete().eq('id', id);
    if (error) {
        alert(`刪除 Q&A 失敗: ${error.message}`);
        return;
    }
    
    alert('規則已刪除，預覽已刷新！');
    loadAllData(); // 重新載入並更新編輯器與預覽
}

// 渲染數據洞察面板
function renderDataInsight() {
    const insightPanel = document.getElementById('dataInsight');
    const totalLogs = currentLogs.length;
    const totalQna = currentQnaRules.length;
    const totalClicks = currentQnaRules.reduce((sum, rule) => sum + (rule.click_count || 0), 0);

    // 計算 Q&A 命中率 (簡單版: 有回答的比例)
    const answeredLogs = currentLogs.filter(log => log.bot_response && log.bot_response.length > 5 && !log.bot_response.includes('抱歉')).length;
    const hitRate = totalLogs > 0 ? (answeredLogs / totalLogs) * 100 : 0;

    // 最常被問到的問題 (Q&A)
    const topQna = [...currentQnaRules].sort((a, b) => (b.click_count || 0) - (a.click_count || 0))[0];

    insightPanel.innerHTML = `
        <div class="section-title">核心數據概覽</div>
        <div class="insight-card">
            <div class="stat-row">
                <div class="stat-label">總對話次數：<span>${totalLogs}</span></div>
                <div class="stat-label">Q&A 總規則數：<span>${totalQna}</span></div>
                <div class="stat-label">Q&A 總點擊數：<span>${totalClicks}</span></div>
            </div>
            <div class="stat-row">
                <div class="stat-label">自動應答率：<span>${hitRate.toFixed(1)}%</span></div>
                <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: ${hitRate}%"></div></div>
            </div>
            <div class="stat-row" style="margin-top:20px;">
                <div class="stat-label" style="font-size:12px; color:#00ffff;">最熱門問題:</div>
                <div class="log-msg" style="color:var(--accent); font-size:14px;">
                    ${topQna ? `${topQna.question} (${topQna.click_count || 0} 次)` : 'N/A'}
                </div>
            </div>
        </div>
    `;
}

// 渲染聊天日誌
function renderChatLogs() {
    const logBody = document.getElementById('chatLogBody');
    logBody.innerHTML = '';
    
    currentLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'log-item';

        const typeTag = log.type === 'button' ? 'Q&A點擊' : (log.type === 'text' ? '文字輸入' : '未知');
        
        item.innerHTML = `
            <div class="log-meta">
                <span>${new Date(log.created_at).toLocaleString()}</span>
                <span class="log-tag">${typeTag}</span>
            </div>
            <div class="log-msg">Q: ${log.message}</div>
            <div class="log-answer">A: ${log.bot_response || '無回應'}</div>
        `;
        logBody.appendChild(item);
    });
}

// ========================================================
// 6. 啟動
// ========================================================
// window.onload 已經包含啟動邏輯，無需再呼叫 init()
</script>
</body>
</html>